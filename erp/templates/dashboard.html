<!DOCTYPE html>
<html>
<head>
  <title>ðŸ“¦ ERP Purchase Order Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f9;
      text-align: center;
      margin: 0;
    }
    header {
      background: #007BFF;
      color: white;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
    }

    /* --- User Icon & Dropdown --- */
    .user-menu {
      position: relative;
      display: inline-block;
    }
    .user-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: white;
      color: #007BFF;
      font-weight: bold;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .user-icon:hover {
      background-color: #e8e8e8;
    }
    .dropdown {
      display: none;
      position: absolute;
      right: 0;
      background: white;
      color: #333;
      min-width: 180px;
      box-shadow: 0px 8px 16px rgba(0,0,0,0.2);
      border-radius: 8px;
      z-index: 1000;
      text-align: left;
    }
    .dropdown.show {
      display: block;
      animation: fadeIn 0.2s ease-in-out;
    }
    .dropdown p {
      padding: 10px 15px;
      margin: 0;
      border-bottom: 1px solid #eee;
      font-size: 14px;
      color: #555;
    }
    .dropdown button {
      width: 100%;
      border: none;
      background: none;
      color: #dc3545;
      padding: 10px 15px;
      text-align: left;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
    }
    .dropdown button:hover {
      background-color: #f5f5f5;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* --- Table & Buttons (same as before) --- */
    h1 {
      margin-top: 30px;
      color: #222;
    }
    table {
      border-collapse: collapse;
      margin: 30px auto;
      width: 90%;
      background: #fff;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 10px 15px;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background: #007BFF;
      color: white;
    }
    tr:hover {
      background: #f1f1f1;
    }
    .btn {
      background: #007BFF;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 10px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .btn:hover {
      background: #0056b3;
    }
    .delete-btn {
      background: #dc3545;
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .delete-btn:hover {
      background: #b02a37;
    }
    #status-message {
      font-weight: bold;
      margin-top: 10px;
    }

    /* --- Modal --- */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      backdrop-filter: blur(2px);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background-color: #fff;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      width: 350px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>

  <header>
    <h1>ðŸ“¦ ERP Purchase Order Dashboard</h1>

    <!-- ðŸ‘¤ User Icon -->
    <div class="user-menu">
      <div class="user-icon" id="userIcon">
        {{ session['email_user'][0].upper() }}
      </div>
      <div class="dropdown" id="userDropdown">
        <p>{{ session['email_user'] }}</p>
        <button onclick="window.location.href='/logout'">ðŸšª Logout</button>
      </div>
    </div>
  </header>

  <button class="btn" id="scanBtn">ðŸ“© Scan for New Emails</button>
  <p id="status-message"></p>

  <table id="ordersTable">
    <thead>
      <tr>
        <th>Order ID</th>
        <th>Product Name</th>
        <th>Quantity</th>
        <th>Due Date</th>
        <th>Retailer Name</th>
        <th>Retailer Email</th>
        <th>Retailer Address</th>
        <th>Email Subject</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for order in orders %}
      <tr>
        <td>{{ order.id }}</td>
        <td>{{ order.product_name }}</td>
        <td>{{ order.quantity_ordered }}</td>
        <td>{{ order.delivery_due_date }}</td>
        <td>{{ order.retailer_name or '' }}</td>
        <td>{{ order.retailer_email }}</td>
        <td>{{ order.retailer_address }}</td>
        <td>{{ order.client_email_subject }}</td>
        <td><button class="delete-btn" onclick="openDeleteModal({{ order.id }})">Delete</button></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- ðŸªŸ Delete Confirmation Modal -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <h3>Are you sure you want to delete this order?</h3>
      <button class="btn confirm-btn" id="confirmDeleteBtn">Yes, Delete</button>
      <button class="btn cancel-btn" onclick="closeDeleteModal()">Cancel</button>
    </div>
  </div>

<script>
  // --- Dropdown menu toggle ---
  const userIcon = document.getElementById("userIcon");
  const userDropdown = document.getElementById("userDropdown");
  userIcon.addEventListener("click", () => {
    userDropdown.classList.toggle("show");
  });

  window.addEventListener("click", (e) => {
    if (!userIcon.contains(e.target) && !userDropdown.contains(e.target)) {
      userDropdown.classList.remove("show");
    }
  });

  // --- Existing JS (delete & scan) ---
  let selectedOrderId = null;
  function openDeleteModal(orderId) {
    selectedOrderId = orderId;
    document.getElementById("deleteModal").style.display = "flex";
  }
  function closeDeleteModal() {
    selectedOrderId = null;
    document.getElementById("deleteModal").style.display = "none";
  }
  document.getElementById("confirmDeleteBtn").addEventListener("click", async () => {
    if (!selectedOrderId) return;
    const response = await fetch(`/delete/${selectedOrderId}`, { method: 'DELETE' });
    const result = await response.json();
    document.getElementById("status-message").innerText = result.message;
    closeDeleteModal();
    loadOrders();
  });
  document.getElementById("scanBtn").addEventListener("click", async () => {
    document.getElementById("status-message").innerText = "â³ Scanning for new emails...";
    const response = await fetch("/scan", { method: "POST" });
    const result = await response.json();
    document.getElementById("status-message").innerText = result.message;
    loadOrders();
  });
  async function loadOrders() {
    const res = await fetch('/orders');
    const data = await res.json();
    const tbody = document.querySelector("#ordersTable tbody");
    tbody.innerHTML = "";
    data.forEach(order => {
      const row = `
        <tr>
          <td>${order.id}</td>
          <td>${order.product_name || ''}</td>
          <td>${order.quantity_ordered || ''}</td>
          <td>${order.delivery_due_date || ''}</td>
          <td>${order.retailer_name || ''}</td>
          <td>${order.retailer_email || ''}</td>
          <td>${order.retailer_address || ''}</td>
          <td>${order.client_email_subject || ''}</td>
          <td><button class="delete-btn" onclick="openDeleteModal(${order.id})">Delete</button></td>
        </tr>`;
      tbody.insertAdjacentHTML('beforeend', row);
    });
  }
</script>
</body>
</html>
