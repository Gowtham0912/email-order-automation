<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OrderIQ</title>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in {
      animation: fadeIn 0.2s ease-in-out;
    }

    /* Loader Animation */
    .loader {
      width: 50px;
      aspect-ratio: 1;
      display: grid;
      color: #854f1d;
      background: radial-gradient(farthest-side, currentColor calc(100% - 6px), #0000 calc(100% - 5px) 0);
      -webkit-mask: radial-gradient(farthest-side, #0000 calc(100% - 13px), #000 calc(100% - 12px));
      border-radius: 50%;
      animation: l19 2s infinite linear;
      margin: 10px auto;
    }
    .loader::before,
    .loader::after {
      content: "";
      grid-area: 1/1;
      background:
        linear-gradient(currentColor 0 0) center,
        linear-gradient(currentColor 0 0) center;
      background-size: 100% 10px, 10px 100%;
      background-repeat: no-repeat;
    }
    .loader::after {
      transform: rotate(45deg);
    }
    @keyframes l19 {
      100% { transform: rotate(1turn); }
    }
  </style>
</head>

<body class="font-sans bg-[#fdca5e] text-center m-0">

  <!-- Header -->
  <div class="bg-white text-white px-5 py-3 flex items-center mx-5 mt-5 rounded">
    <div class="flex items-center space-x-3">
      <img src="/static/logo.png" alt="Logo" class="w-12 object-contain" />
      <h1 class="m-0 text-black font-bold text-2xl font-semibold">OrderIQ</h1>
    </div>

    <!-- ðŸ‘¤ User Menu -->
    <div class="relative inline-block ml-auto">
      <div id="userIcon"
        class="w-10 h-10 rounded-full bg-white text-[#eaa73e] font-bold text-xl flex items-center justify-center cursor-pointer lg:bg-[#795227] hover:bg-black md:bg-[#795227] sm:bg-[#795227] transition">
        {{ session['email_user'][0].upper() }}
      </div>

      <div id="userDropdown"
        class="hidden absolute right-0 mt-2 bg-white text-gray-800 min-w-[180px] rounded-lg shadow-lg text-left z-50">
        <p class="px-4 py-2 border-b border-gray-200 text-sm text-gray-600">{{ session['email_user'] }}</p>
        <button onclick="window.location.href='/logout'"
          class="w-full text-left px-4 py-2 text-sm font-bold text-red-600 hover:bg-gray-100 transition">
          ðŸšª Logout
        </button>
      </div>
    </div>
  </div>

  <!-- Status Message -->
  <p id="status-message" class="font-bold mt-3"></p>

  <!-- Buttons -->
  <div class="w-[95%] h-12 mx-auto flex justify-between items-center relative">

    <!-- Left: Scan Button -->
    <div class="flex items-center">
      <button id="scanBtn"
        class="flex items-center gap-2 bg-[#7c5327] hover:bg-black text-white px-6 py-2 rounded-md font-medium transition">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
             stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
          <path stroke-linecap="round" stroke-linejoin="round"
                d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
        </svg>
        <span>Scan for New Emails</span>
      </button>
    </div>

    <!-- Right: Download Button -->
    <div class="relative flex items-center">
      <button id="downloadBtn"
        class="flex items-center gap-2 bg-[#7c5327] hover:bg-black text-white font-medium px-4 py-2 rounded-md transition">
        <span>Download</span>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none"
             viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"
             class="w-5 h-5">
          <path stroke-linecap="round" stroke-linejoin="round"
                d="m9 13.5 3 3m0 0 3-3m-3 3v-6m1.06-4.19-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z" />
        </svg>
      </button>

      <!-- Dropdown Menu -->
      <div id="downloadMenu"
        class="hidden absolute right-0 top-14 bg-white shadow-lg rounded-md w-48 text-left border border-gray-200 z-50">
        <button onclick="window.location.href='/export/pdf'"
          class="w-full text-gray-700 hover:bg-black hover:text-white px-4 py-2 flex items-center gap-2 transition rounded-md">
          ðŸ“„ Download as PDF
        </button>
        <button onclick="window.location.href='/export/excel'"
          class="w-full text-gray-700 hover:bg-black hover:text-white px-4 py-2 flex items-center gap-2 transition rounded-md">
          ðŸ“Š Download as Excel
        </button>
      </div>
    </div>
  </div>

  <!-- Orders Table -->
  <div class="mt-6 w-[95%] mx-auto bg-white rounded-lg shadow-md border border-gray-300 overflow-y-auto max-h-[70vh] p-3">
    <div class="flex bg-[#7c5327] text-white font-semibold py-3 px-4 rounded-md text-sm">
      <div class="w-1/12">Order ID</div>
      <div class="w-2/12">Product Name</div>
      <div class="w-1/12">Quantity</div>
      <div class="w-2/12">Due Date</div>
      <div class="w-2/12">Retailer Name</div>
      <div class="w-2/12">Retailer Email</div>
      <div class="w-3/12">Retailer Address</div>
      <div class="w-3/12">Email Subject</div>
      <div class="w-1/12">Actions</div>
    </div>

    <div id="ordersList" class="divide-y divide-gray-200">
      {% for order in orders %}
      <div class="flex items-center py-3 px-4 hover:bg-gray-50 text-sm">
        <div class="w-1/12">{{ order.id }}</div>
        <div class="w-2/12">{{ order.product_name }}</div>
        <div class="w-1/12">{{ order.quantity_ordered }}</div>
        <div class="w-2/12">{{ order.delivery_due_date }}</div>
        <div class="w-2/12">{{ order.retailer_name or '' }}</div>
        <div class="w-2/12">{{ order.retailer_email }}</div>
        <div class="w-3/12 truncate">{{ order.retailer_address }}</div>
        <div class="w-3/12 truncate">{{ order.client_email_subject }}</div>
        <div class="w-1/12">
          <button onclick="openDeleteModal({{ order.id }})"
            class="bg-[#dc3545] hover:bg-[#b02a37] text-white px-3 py-1 rounded transition">Delete</button>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal"
    class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex justify-center items-center z-50">
    <div class="bg-white rounded-xl shadow-lg p-6 w-[350px] text-center">
      <h3 class="text-lg font-semibold mb-4">Are you sure you want to delete this order?</h3>
      <button id="confirmDeleteBtn"
        class="bg-[#007BFF] hover:bg-[#0056b3] text-white px-4 py-2 rounded-md mx-2 font-medium transition">Yes, Delete</button>
      <button onclick="closeDeleteModal()"
        class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-md mx-2 font-medium transition">Cancel</button>
    </div>
  </div>

  <script>
    // --- User Menu ---
    const userIcon = document.getElementById("userIcon");
    const userDropdown = document.getElementById("userDropdown");
    userIcon.addEventListener("click", (e) => {
      e.stopPropagation();
      userDropdown.classList.toggle("hidden");
      userDropdown.classList.toggle("fade-in");
    });
    window.addEventListener("click", (e) => {
      if (!userDropdown.classList.contains("hidden") && !userIcon.contains(e.target)) {
        userDropdown.classList.add("hidden");
      }
    });

    // --- Download Dropdown ---
    const downloadBtn = document.getElementById("downloadBtn");
    const downloadMenu = document.getElementById("downloadMenu");

    downloadBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      downloadMenu.classList.toggle("hidden");
    });

    window.addEventListener("click", (e) => {
      if (!downloadMenu.classList.contains("hidden") && !downloadBtn.contains(e.target)) {
        downloadMenu.classList.add("hidden");
      }
    });

    // --- Delete ---
    let selectedOrderId = null;
    function openDeleteModal(orderId) {
      selectedOrderId = orderId;
      document.getElementById("deleteModal").classList.remove("hidden");
    }
    function closeDeleteModal() {
      selectedOrderId = null;
      document.getElementById("deleteModal").classList.add("hidden");
    }

    document.getElementById("confirmDeleteBtn").addEventListener("click", async () => {
      if (!selectedOrderId) return;
      const response = await fetch(`/delete/${selectedOrderId}`, { method: 'DELETE' });
      const result = await response.json();
      document.getElementById("status-message").innerText = result.message;
      closeDeleteModal();
      loadOrders();
    });

    // --- Scan Button with Loader ---
    document.getElementById("scanBtn").addEventListener("click", async () => {
      const status = document.getElementById("status-message");
      status.innerHTML = '<div class="loader"></div><p class="text-[#7c5327] font-semibold mt-2">Scanning for new emails...</p>';

      const response = await fetch("/scan", { method: "POST" });
      const result = await response.json();

      status.innerHTML = `<p>${result.message}</p>`;
      loadOrders();
    });

    async function loadOrders() {
      const res = await fetch('/orders');
      const data = await res.json();
      const list = document.getElementById("ordersList");
      list.innerHTML = "";
      data.forEach(order => {
        const row = `
          <div class="flex items-center py-3 px-4 hover:bg-gray-50 text-sm">
            <div class="w-1/12">${order.id}</div>
            <div class="w-2/12">${order.product_name || ''}</div>
            <div class="w-1/12">${order.quantity_ordered || ''}</div>
            <div class="w-2/12">${order.delivery_due_date || ''}</div>
            <div class="w-2/12">${order.retailer_name || ''}</div>
            <div class="w-2/12">${order.retailer_email || ''}</div>
            <div class="w-3/12 truncate">${order.retailer_address || ''}</div>
            <div class="w-3/12 truncate">${order.client_email_subject || ''}</div>
            <div class="w-1/12">
              <button onclick="openDeleteModal(${order.id})"
                class="bg-[#dc3545] hover:bg-[#b02a37] text-white px-3 py-1 rounded transition">Delete</button>
            </div>
          </div>`;
        list.insertAdjacentHTML('beforeend', row);
      });
    }
  </script>
</body>
</html>
