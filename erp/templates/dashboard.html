<!DOCTYPE html>
<html>
<head>
  <title>ðŸ“¦ ERP Purchase Order Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f9;
      text-align: center;
      margin: 0;
    }
    h1 {
      margin-top: 30px;
      color: #222;
    }
    table {
      border-collapse: collapse;
      margin: 30px auto;
      width: 90%;
      background: #fff;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 10px 15px;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background: #007BFF;
      color: white;
    }
    tr:hover {
      background: #f1f1f1;
    }
    .btn {
      background: #007BFF;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 10px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .btn:hover {
      background: #0056b3;
    }
    .delete-btn {
      background: #dc3545;
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .delete-btn:hover {
      background: #b02a37;
    }
    #status-message {
      font-weight: bold;
      margin-top: 10px;
    }

    /* --- Modal Styles --- */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      backdrop-filter: blur(2px);
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s;
    }

    .modal-content {
      background-color: #fff;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      width: 350px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      animation: slideDown 0.3s ease;
    }

    .modal h3 {
      margin-bottom: 20px;
      color: #333;
    }

    .modal button {
      margin: 10px;
      padding: 8px 15px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 15px;
    }

    .confirm-btn {
      background-color: #dc3545;
      color: white;
    }

    .cancel-btn {
      background-color: #6c757d;
      color: white;
    }

    .confirm-btn:hover {
      background-color: #b02a37;
    }

    .cancel-btn:hover {
      background-color: #5a6268;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideDown {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
  </style>
</head>
<body>

  <h1>ðŸ“¦ ERP Purchase Order Dashboard</h1>
  <button class="btn" id="scanBtn">ðŸ“© Scan for New Emails</button>
  <p id="status-message"></p>

  <table id="ordersTable">
    <thead>
      <tr>
        <th>Order ID</th>
        <th>Product Name</th>
        <th>Quantity</th>
        <th>Due Date</th>
        <th>Retailer Name</th>
        <th>Retailer Email</th>
        <th>Retailer Address</th>
        <th>Email Subject</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for order in orders %}
      <tr>
        <td>{{ order.id }}</td>
        <td>{{ order.product_name }}</td>
        <td>{{ order.quantity_ordered }}</td>
        <td>{{ order.delivery_due_date }}</td>
        <td>{{ order.retailer_name or '' }}</td>
        <td>{{ order.retailer_email }}</td>
        <td>{{ order.retailer_address }}</td>
        <td>{{ order.client_email_subject }}</td>
        <td><button class="delete-btn" onclick="openDeleteModal({{ order.id }})">Delete</button></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- ðŸªŸ Delete Confirmation Modal -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <h3>Are you sure you want to delete this order?</h3>
      <button class="confirm-btn" id="confirmDeleteBtn">Yes, Delete</button>
      <button class="cancel-btn" onclick="closeDeleteModal()">Cancel</button>
    </div>
  </div>

<script>
  let selectedOrderId = null;

  // --- Open Modal ---
  function openDeleteModal(orderId) {
    selectedOrderId = orderId;
    document.getElementById("deleteModal").style.display = "flex";
  }

  // --- Close Modal ---
  function closeDeleteModal() {
    selectedOrderId = null;
    document.getElementById("deleteModal").style.display = "none";
  }

  // --- Confirm Delete ---
  document.getElementById("confirmDeleteBtn").addEventListener("click", async () => {
    if (!selectedOrderId) return;
    const response = await fetch(`/delete/${selectedOrderId}`, { method: 'DELETE' });
    const result = await response.json();
    document.getElementById("status-message").innerText = result.message;
    closeDeleteModal();
    loadOrders(); // Refresh table
  });

  // --- Scan for New Emails ---
  document.getElementById("scanBtn").addEventListener("click", async () => {
    document.getElementById("status-message").innerText = "â³ Scanning for new emails...";
    const response = await fetch("/scan", { method: "POST" });
    const result = await response.json();
    document.getElementById("status-message").innerText = result.message;
    loadOrders(); // Refresh automatically
  });

  // --- Reload Orders without page refresh ---
  async function loadOrders() {
    const res = await fetch('/orders');
    const data = await res.json();
    const tbody = document.querySelector("#ordersTable tbody");
    tbody.innerHTML = "";
    data.forEach(order => {
      const row = `
        <tr>
          <td>${order.id}</td>
          <td>${order.product_name || ''}</td>
          <td>${order.quantity_ordered || ''}</td>
          <td>${order.delivery_due_date || ''}</td>
          <td>${order.retailer_name || ''}</td>
          <td>${order.retailer_email || ''}</td>
          <td>${order.retailer_address || ''}</td>
          <td>${order.client_email_subject || ''}</td>
          <td><button class="delete-btn" onclick="openDeleteModal(${order.id})">Delete</button></td>
        </tr>`;
      tbody.insertAdjacentHTML('beforeend', row);
    });
  }
</script>
</body>
</html>
